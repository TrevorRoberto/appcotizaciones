<script>
  async function generarCotizacion() {
    const peso = parseFloat(document.getElementById("pesoObjeto").value);
    const costoFilamento = parseFloat(document.getElementById("costoFilamento").value);
    const horas = parseFloat(document.getElementById("horasImpresion").value);
    const minutos = parseFloat(document.getElementById("minutosImpresion").value);
    const minutosPost = parseFloat(document.getElementById("minutosPost").value);
    const costoImpresora = parseFloat(document.getElementById("costoImpresora").value);
    const horasPorDia = parseFloat(document.getElementById("horasPorDia").value);
    const aniosVida = parseFloat(document.getElementById("aniosVida").value);
    const costoElectricidad = parseFloat(document.getElementById("costoElectricidad").value);
    const costoSupervision = parseFloat(document.getElementById("costoSupervision").value);
    const costoMantenimiento = parseFloat(document.getElementById("costoMantenimiento").value);
    const costoPreparacion = parseFloat(document.getElementById("costoPreparacion").value);
    const costoPostProcesado = parseFloat(document.getElementById("costoPostProcesado").value);
    const porcentajeMerma = parseFloat(document.getElementById("porcentajeMerma").value);
    const porcentajeGanancia = parseFloat(document.getElementById("porcentajeGanancia").value);
    const iva = parseFloat(document.getElementById("iva").value);
    const nombreCliente = document.getElementById("nombreCliente").value;
    const nombreProducto = document.getElementById("nombreProducto").value;
    const nombreArchivo = document.getElementById("nombreArchivo").value || "cotizacion";

    const horasTotales = horas + minutos / 60;
    const horasVidaTotal = horasPorDia * 365 * aniosVida;
    const depreciacionHora = costoImpresora / horasVidaTotal;

    const depreciacion = depreciacionHora * horasTotales;
    const electricidad = costoElectricidad * horasTotales;
    const mantenimiento = costoMantenimiento * horasTotales;
    const supervision = costoSupervision * horasTotales;

    const costoMaterial = (peso / 1000) * costoFilamento;
    const merma = (costoMaterial * porcentajeMerma) / 100;

    const usoMaquina = depreciacion + electricidad + mantenimiento + supervision;
    const preparacion = costoPreparacion * 1;
    const postprocesado = (minutosPost / 60) * costoPostProcesado;

    const subtotal = usoMaquina + costoMaterial + preparacion + postprocesado + merma;
    const ganancia = (subtotal * porcentajeGanancia) / 100;
    const totalSinIVA = subtotal + ganancia;
    const totalIVA = (totalSinIVA * iva) / 100;
    const totalFinal = totalSinIVA + totalIVA;

    const resultadosHTML = `
      <strong>Depreciación:</strong> $${depreciacion.toFixed(2)}<br>
      <strong>Electricidad:</strong> $${electricidad.toFixed(2)}<br>
      <strong>Mantenimiento:</strong> $${mantenimiento.toFixed(2)}<br>
      <strong>Supervisión:</strong> $${supervision.toFixed(2)}<br>
      <strong>Costo de material:</strong> $${costoMaterial.toFixed(2)}<br>
      <strong>Uso de máquina:</strong> $${usoMaquina.toFixed(2)}<br>
      <strong>Preparación:</strong> $${preparacion.toFixed(2)}<br>
      <strong>Post-procesado:</strong> $${postprocesado.toFixed(2)}<br>
      <strong>Merma aplicada:</strong> $${merma.toFixed(2)}<br>
      <strong>Total sugerido:</strong> <strong>$${totalFinal.toFixed(2)}</strong>
    `;
    document.getElementById("resultados").innerHTML = resultadosHTML;

    // Crear PDF con jsPDF
    const { jsPDF } = window.jspdf;
    const doc = new jsPDF();

    doc.setFontSize(14);
    doc.text("Cotización de impresión 3D", 20, 20);
    doc.setFontSize(12);
    doc.text(`Cliente: ${nombreCliente}`, 20, 30);
    doc.text(`Producto: ${nombreProducto}`, 20, 37);
    doc.text(`-------------------------------`, 20, 43);
    doc.text(`Depreciación: $${depreciacion.toFixed(2)}`, 20, 50);
    doc.text(`Electricidad: $${electricidad.toFixed(2)}`, 20, 57);
    doc.text(`Mantenimiento: $${mantenimiento.toFixed(2)}`, 20, 64);
    doc.text(`Supervisión: $${supervision.toFixed(2)}`, 20, 71);
    doc.text(`Costo de material: $${costoMaterial.toFixed(2)}`, 20, 78);
    doc.text(`Preparación: $${preparacion.toFixed(2)}`, 20, 85);
    doc.text(`Post-procesado: $${postprocesado.toFixed(2)}`, 20, 92);
    doc.text(`Merma: $${merma.toFixed(2)}`, 20, 99);
    doc.text(`Ganancia: $${ganancia.toFixed(2)}`, 20, 106);
    doc.text(`IVA: $${totalIVA.toFixed(2)}`, 20, 113);
    doc.setFontSize(14);
    doc.text(`TOTAL: $${totalFinal.toFixed(2)}`, 20, 123);

    doc.save(`${nombreArchivo}.pdf`);
  }
</script>
